name: Quality Gate (GitHub API)

on:
  workflow_dispatch:

jobs:
  quality-gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do quality-gate
        uses: actions/checkout@v4

      - name: Criar CSV
        run: echo "repo,linguagem,versao_atual,versao_minima,status" > inventory.csv

      - name: Quality Gate via GitHub API (recursivo)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          baseline_java=$(jq -r '.java' baseline.json)
          baseline_dotnet=$(jq -r '.dotnet' baseline.json)

          repos=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/user/repos?per_page=100&visibility=all&affiliation=owner")

          echo "$repos" | jq -r '.[].name' | while read repo; do
            echo "üîç Processando $repo"

            language="DESCONHECIDO"
            version="N/A"
            baseline="N/A"
            result="N/A"

            # Branch default
            branch=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/${{ github.repository_owner }}/$repo" \
              | jq -r '.default_branch')

            tree=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/${{ github.repository_owner }}/$repo/git/trees/$branch?recursive=1")

              # -------------------
              # JAVA (Spring / Quarkus / Legacy)
              # -------------------
              
              pom_path=$(echo "$tree" | jq -r '.tree[].path' | grep -m1 'pom.xml' || true)
              
              java_found=false
              
              if [ -n "$pom_path" ]; then
                java_found=true
                language="Java"
                baseline="$baseline_java"
              
                pom=$(curl -s -H "Authorization: token $GH_TOKEN" \
                  "https://api.github.com/repos/${{ github.repository_owner }}/$repo/contents/$pom_path?ref=$branch")
              
                content=$(echo "$pom" | jq -r '.content' | base64 -d)
              
                # Ordem REAL de prioridade
                version=$(
                  echo "$content" | grep -oPm1 "(?<=<java.version>)[^<]+" ||
                  echo "$content" | grep -oPm1 "(?<=<maven.compiler.release>)[^<]+" ||
                  echo "$content" | grep -oPm1 "(?<=<maven.compiler.source>)[^<]+" ||
                  echo "NAO_DECLARADA"
                )
              
                # Normaliza Java 1.8 ‚Üí 8
                version=$(echo "$version" | sed 's/^1\.//')
              
                if [ "$version" = "NAO_DECLARADA" ]; then
                  result="ABAIXO"
                else
                  status=$(printf '%s\n%s' "$baseline" "$version" | sort -V | head -n1)
                  [ "$status" != "$baseline" ] && result="ABAIXO" || result="OK"
                fi
              fi
              
              # -------------------
              # JAVA LEGADO (sem build)
              # -------------------
              
              if [ "$java_found" = false ]; then
                java_files=$(echo "$tree" | jq -r '.tree[].path' | grep '\.java$' || true)
              
                if [ -n "$java_files" ]; then
                  language="Java-LEGACY"
                  version="N/A"
                  baseline="$baseline_java"
                  result="ABAIXO"
                fi
              fi                

            # -------------------
            # DOTNET
            # -------------------
            csproj=$(echo "$tree" | jq -r '.tree[].path' | grep -m1 '\.csproj$' || true)

            if [ -n "$csproj" ]; then
              language=".NET"
              baseline="$baseline_dotnet"

              proj=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/${{ github.repository_owner }}/$repo/contents/$csproj?ref=$branch")

              content=$(echo "$proj" | jq -r '.content' | base64 -d)

              version=$(echo "$content" | grep -oPm1 "(?<=<TargetFramework>net)[0-9.]+" | sed 's/\.0$//' || echo "NAO_DECLARADA")

              if [ "$version" = "NAO_DECLARADA" ]; then
                result="ABAIXO"
              else
                status=$(printf '%s\n%s' "$baseline" "$version" | sort -V | head -n1)
                [ "$status" != "$baseline" ] && result="ABAIXO" || result="OK"
              fi
            fi

            echo "$repo,$language,$version,$baseline,$result" >> inventory.csv
          done

      - name: Upload CSV
        uses: actions/upload-artifact@v4
        with:
          name: quality-gate-inventory
          path: inventory.csv

