name: Quality Gate (GitHub API)

on:
  workflow_dispatch:

permissions:
  contents: write
    
jobs:
  quality-gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do quality-gate
        uses: actions/checkout@v4

      - name: Quality Gate via GitHub API (recursivo)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          DATA_EXECUCAO=$(date -u +"%Y-%m-%d")
          echo "DATA_EXECUCAO=$DATA_EXECUCAO" >> $GITHUB_ENV
      
          ORG="${{ github.repository_owner }}"
          
          mkdir -p results/$DATA_EXECUCAO
          CSV_PATH="results/$DATA_EXECUCAO/inventory.csv"
          
          echo "org,repo,linguagem,versao_atual,baseline_min,baseline_target,status,data_execucao" > "$CSV_PATH"
              
          baseline_java_min=$(jq -r '.java.min' baselines/baseline.json)
          baseline_java_target=$(jq -r '.java.target' baselines/baseline.json)
          
          baseline_dotnet_min=$(jq -r '.dotnet.min' baselines/baseline.json)
          baseline_dotnet_target=$(jq -r '.dotnet.target' baselines/baseline.json)
          
          repos=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/user/repos?per_page=100&visibility=all&affiliation=owner")

          echo "$repos" | jq -r '.[].name' | while read repo; do
            echo "Processando $repo"

            if [ "$repo" = "quality-gate" ]; then
              echo "$ORG,$repo,DESCONHECIDO,N/A,N/A,N/A,N/A,$DATA_EXECUCAO" >> "$CSV_PATH"
              continue
            fi

            language="DESCONHECIDO"
            version="N/A"
            baseline_min="N/A"
            baseline_target="N/A"
            result="N/A"

            TECH_DETECTED=false

            # Branch default
            branch=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/${{ github.repository_owner }}/$repo" \
              | jq -r '.default_branch')

            tree=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/${{ github.repository_owner }}/$repo/git/trees/$branch?recursive=1")

              # -------------------
              # JAVA (Spring / Quarkus / Legacy)
              # -------------------
              
              pom_path=$(
                echo "$tree" | jq -r '.tree[].path' \
                | grep '^pom.xml$' \
                || echo "$tree" | jq -r '.tree[].path' | grep 'pom.xml' | sort | head -n1
              )
              
              java_found=false
              
              if [ -n "$pom_path" ] && [ "$TECH_DETECTED" = false ]; then
                TECH_DETECTED=true
                language="Java"
                baseline_min="$baseline_java_min"
                baseline_target="$baseline_java_target"
            
                pom=$(curl -s -H "Authorization: token $GH_TOKEN" \
                  "https://api.github.com/repos/${{ github.repository_owner }}/$repo/contents/$pom_path?ref=$branch")
              
                content=$(echo "$pom" | jq -r '.content' | base64 -d)
              
                # Ordem REAL de prioridade
                version=$(
                  echo "$content" | grep -oPm1 "(?<=<java.version>)[^<]+" ||
                  echo "$content" | grep -oPm1 "(?<=<maven.compiler.release>)[^<]+" ||
                  echo "$content" | grep -oPm1 "(?<=<maven.compiler.source>)[^<]+" ||
                  echo "$content" | grep -oPm1 "(?<=<maven.compiler.target>)[^<]+" ||
                  echo "NAO_DECLARADA"
                )                
              
                # Normaliza Java 1.8 → 8
                version=$(echo "$version" | sed 's/^1\.//')
              
                if [ "$version" = "NAO_DECLARADA" ]; then
                  result="ABAIXO"
                else
                  if [ "$(printf '%s\n%s' "$baseline_java_min" "$version" | sort -V | head -n1)" != "$baseline_java_min" ]; then
                    result="ABAIXO_MINIMO"
                  elif [ "$(printf '%s\n%s' "$baseline_java_target" "$version" | sort -V | head -n1)" != "$baseline_java_target" ]; then
                    result="ABAIXO_TARGET"
                  else
                    result="OK"
                  fi             
                fi
              fi
              
              # -------------------
              # JAVA LEGADO (sem build)
              # -------------------
              
              if [ "$TECH_DETECTED" = false ]; then
                java_files=$(echo "$tree" | jq -r '.tree[].path' | grep '\.java$' || true)
              
                if [ -n "$java_files" ]; then
                  TECH_DETECTED=true
                  language="Java-LEGACY"
                  version="N/A"
                  baseline_min="$baseline_java_min"
                  baseline_target="$baseline_java_target"
                  result="ABAIXO"
                fi
              fi
                             

            # -------------------
            # DOTNET
            # -------------------
              csproj=$(echo "$tree" | jq -r '.tree[].path' \
              | grep -v '^\.github/' \
              | grep -v '^docs/' \
              | grep -v '^scripts/' \
              | grep -m1 '\.csproj$' || true)
            
            if [ -n "$csproj" ] && [ "$TECH_DETECTED" = false ]; then

              TECH_DETECTED=true
              language=".NET"
              baseline_min="$baseline_dotnet_min"
              baseline_target="$baseline_dotnet_target"
                 
              proj=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/${{ github.repository_owner }}/$repo/contents/$csproj?ref=$branch")

              content=$(echo "$proj" | jq -r '.content' | base64 -d)

              version=$(echo "$content" | grep -oPm1 "(?<=<TargetFramework>net)[0-9.]+" | sed 's/\.0$//' || echo "NAO_DECLARADA")

              if [ "$version" = "NAO_DECLARADA" ]; then
                result="ABAIXO"
              else
                if [ "$(printf '%s\n%s' "$baseline_min" "$version" | sort -V | head -n1)" != "$baseline_min" ]; then
                  result="ABAIXO_MINIMO"
                elif [ "$(printf '%s\n%s' "$baseline_target" "$version" | sort -V | head -n1)" != "$baseline_target" ]; then
                  result="ABAIXO_TARGET"
                else
                  result="OK"
                fi
              fi
            fi

            if [ "$TECH_DETECTED" = false ]; then
              language="DESCONHECIDO"
              version="N/A"
              baseline_min="N/A"
              baseline_target="N/A"
              result="N/A"
            fi

            echo "$ORG,$repo,$language,$version,$baseline_min,$baseline_target,$result,$DATA_EXECUCAO" >> "$CSV_PATH"
          done

      - name: Upload inventory CSV (somente da execução)
        uses: actions/upload-artifact@v4
        with:
          name: inventory-${{ github.run_id }}
          path: results/${{ env.DATA_EXECUCAO }}/inventory.csv
          if-no-files-found: error
        
      - name: Commitar resultados
        run: |
          git config user.name "quality-gate-bot"
          git config user.email "quality-gate@github.com"
      
          git add results/
          git commit -m "Quality Gate results - $(date -u +'%Y-%m-%d')" || echo "Nada para commitar"
      
          git pull --rebase origin master
          git push
        
        
        
        

