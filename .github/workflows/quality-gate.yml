name: Quality Gate

on:
  workflow_dispatch:

jobs:
  aggregate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do quality-gate
        uses: actions/checkout@v4

      - name: Baixar lista de repositórios (públicos + privados)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          curl -s \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/user/repos?per_page=100&visibility=all&affiliation=owner" \
            | jq -r '.[].clone_url' > repos.txt
      
      - name: Clonar repositórios (com acesso a privados)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          mkdir repos
          while read repo; do
            name=$(basename "$repo" .git)
            auth_repo=$(echo "$repo" | sed "s|https://|https://$GH_TOKEN@|")
            git clone "$auth_repo" "repos/$name"
          done < repos.txt
          
      - name: Criar CSV
        run: |
          echo "repo,linguagem,versao_atual,versao_minima,status" > inventory.csv

      - name: Detectar Java e .NET
        run: |
          baseline_java=$(jq -r '.java' baseline.json)
          baseline_dotnet=$(jq -r '.dotnet' baseline.json)
      
          for repo in repos/*; do
            name=$(basename "$repo")
      
            language="DESCONHECIDO"
            version="N/A"
            baseline="N/A"
            result="N/A"
      
            cd "$repo"
      
            # -------------------
            # JAVA (recursivo)
            # -------------------
            pom=$(find . -name pom.xml | head -n 1)
      
            if [ -n "$pom" ]; then
              language="Java"
              baseline="$baseline_java"

              version=$(grep -oPm1 "(?<=<java.version>)[^<]+" "$pom" \
                || grep -oPm1 "(?<=<maven.compiler.source>)[^<]+" "$pom" \
                || true)

              if [ -z "$version" ]; then
                version="NAO_DECLARADA"
                result="ABAIXO"
              else
                status=$(printf '%s\n%s' "$baseline" "$version" | sort -V | head -n1)
                [ "$status" != "$baseline" ] && result="ABAIXO" || result="OK"
              fi
            fi

            # -------------------
            # DOTNET (recursivo)
            # -------------------
            dotnet=$(find . -name "*.csproj" -o -name "global.json" | head -n 1)
      
            if [ -n "$dotnet" ]; then
              language=".NET"
              baseline="$baseline_dotnet"
      
              if [[ "$dotnet" == *global.json ]]; then
                version=$(jq -r '.sdk.version' "$dotnet")
              else
                version=$(grep -oPm1 "(?<=<TargetFramework>net)[^<]+" "$dotnet")
              fi
      
              status=$(printf '%s\n%s' "$baseline" "$version" | sort -V | head -n1)
              [ "$status" != "$baseline" ] && result="ABAIXO" || result="OK"
            fi
      
            cd ../..
      
            echo "$name,$language,$version,$baseline,$result" >> inventory.csv
          done
        
      - name: Upload CSV
        uses: actions/upload-artifact@v4
        with:
          name: quality-gate-inventory
          path: inventory.csv
