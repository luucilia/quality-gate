name: Quality Gate

on:
  workflow_dispatch:

jobs:
  aggregate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do quality-gate
        uses: actions/checkout@v4

      - name: Baixar lista de repositórios
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          curl -s \
            -H "Authorization: token $GH_TOKEN" \
            https://api.github.com/user/repos?per_page=100 \
            | jq -r '.[].clone_url' > repos.txt

      - name: Clonar repositórios
        run: |
          mkdir repos
          while read repo; do
            name=$(basename "$repo" .git)
            git clone "$repo" "repos/$name" || true
          done < repos.txt

      - name: Criar CSV
        run: |
          echo "repo,linguagem,versao_atual,versao_minima,status" > inventory.csv

      - name: Detectar Java e .NET
        run: |
          baseline_java=$(jq -r '.java' baseline.json)
          baseline_dotnet=$(jq -r '.dotnet' baseline.json)
      
          for repo in repos/*; do
            name=$(basename "$repo")
      
            language="DESCONHECIDO"
            version="N/A"
            baseline="N/A"
            result="N/A"
      
            cd "$repo"
      
            # -------------------
            # JAVA (Maven / Gradle)
            # -------------------
            if [ -f "pom.xml" ]; then
              language="Java"
              version=$(grep -oPm1 "(?<=<java.version>)[^<]+" pom.xml || true)
              baseline="$baseline_java"
            elif [ -f "build.gradle" ] || [ -f "gradle.properties" ]; then
              language="Java"
              version=$(grep -oPm1 "(?<=sourceCompatibility = ')[^']+" build.gradle gradle.properties 2>/dev/null || true)
              baseline="$baseline_java"
            fi
      
            # -------------------
            # DOTNET
            # -------------------
            if [ -f "global.json" ]; then
              language=".NET"
              version=$(jq -r '.sdk.version' global.json)
              baseline="$baseline_dotnet"
            elif ls *.csproj *.fsproj *.vbproj 1> /dev/null 2>&1; then
              language=".NET"
              version=$(grep -oPm1 "(?<=<TargetFramework>net)[^<]+" *.csproj *.fsproj *.vbproj 2>/dev/null || true)
              baseline="$baseline_dotnet"
            fi
      
            # -------------------
            # COMPARAÇÃO
            # -------------------
            if [ "$version" != "N/A" ] && [ "$baseline" != "N/A" ]; then
              status=$(printf '%s\n%s' "$baseline" "$version" | sort -V | head -n1)
              [ "$status" != "$baseline" ] && result="ABAIXO" || result="OK"
            fi
      
            cd ../..
      
            echo "$name,$language,$version,$baseline,$result" >> inventory.csv
          done        

      - name: Upload CSV
        uses: actions/upload-artifact@v4
        with:
          name: quality-gate-inventory
          path: inventory.csv
